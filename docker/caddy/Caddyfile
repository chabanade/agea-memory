# ===========================================
# Caddy - Reverse Proxy HTTPS automatique
# ===========================================
# Domaine actuel : srv987452.hstgr.cloud
# Migration future : agea.hexagon-enr.fr (changer la ligne ci-dessous)
# ===========================================

{$BOT_DOMAIN:srv987452.hstgr.cloud} {
	# Webhook n8n -> n8n (Phase 4 - workflows IA)
	handle /webhook/agea-bridge {
		reverse_proxy n8n-n8n-1:5678
	}

	# Webhook Telegram -> Bot FastAPI
	handle /webhook/* {
		reverse_proxy bot:8000
	}

	# API bot (health, status)
	handle /health {
		reverse_proxy bot:8000
	}

	handle /status {
		reverse_proxy bot:8000
	}

	# API Bridge Inter-IA -> Bot FastAPI (Phase 1)
	handle /api/context {
		reverse_proxy bot:8000
	}
	handle /api/memo {
		reverse_proxy bot:8000
	}
	handle /api/session/* {
		reverse_proxy bot:8000
	}

	# API Graphiti -> Bot FastAPI (Phase 5)
	handle /api/facts {
		reverse_proxy bot:8000
	}
	handle /api/correct {
		reverse_proxy bot:8000
	}
	handle /api/entity/* {
		reverse_proxy bot:8000
	}
	handle /api/graphiti/* {
		reverse_proxy bot:8000
	}
	handle /api/admin/* {
		reverse_proxy bot:8000
	}

	# API Zep interne (memoire directe)
	handle /api/* {
		reverse_proxy zep:8080
	}

	# Zep healthcheck
	handle /healthz {
		reverse_proxy zep:8080
	}

	# Par defaut -> bot
	handle {
		reverse_proxy bot:8000
	}
}
